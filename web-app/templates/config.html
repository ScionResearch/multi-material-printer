{% extends "base.html" %}

{% block title %}Configuration - Scion Multi-Material Printer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="bi bi-sliders"></i> System Configuration
        </h1>
    </div>
</div>

<!-- Configuration Tabs -->
<ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pump-tab" data-bs-toggle="tab" data-bs-target="#pump-config" type="button" role="tab">
            <i class="bi bi-droplet"></i> Pump Settings
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network-config" type="button" role="tab">
            <i class="bi bi-wifi"></i> Network Settings
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="logging-tab" data-bs-toggle="tab" data-bs-target="#logging-config" type="button" role="tab">
            <i class="bi bi-journal-text"></i> Logging & Debug
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="diagnostics-tab" data-bs-toggle="tab" data-bs-target="#diagnostics" type="button" role="tab">
            <i class="bi bi-cpu"></i> Hardware Diagnostics
        </button>
    </li>
</ul>

<div class="tab-content" id="configTabsContent">
    <!-- Pump Configuration Tab -->
    <div class="tab-pane fade show active" id="pump-config" role="tabpanel">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="bi bi-droplet"></i> Pump Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="pump-config-form">
                            <div id="pump-settings">
                                <!-- Pump settings will be populated by JavaScript -->
                            </div>

                            <hr>

                            <h6><i class="bi bi-gear"></i> Material Change Settings</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Drain Volume (ml)</label>
                                    <input type="number" class="form-control" id="drain-volume" min="0" max="200" step="1">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Fill Volume (ml)</label>
                                    <input type="number" class="form-control" id="fill-volume" min="0" max="200" step="1">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Settle Time (s)</label>
                                    <input type="number" class="form-control" id="settle-time" min="0" max="30" step="1">
                                </div>
                            </div>

                            <hr>

                            <h6><i class="bi bi-shield"></i> Safety Settings</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Max Pump Runtime (s)</label>
                                    <input type="number" class="form-control" id="max-runtime" min="10" max="600" step="10">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Sensor Check Interval (s)</label>
                                    <input type="number" class="form-control" id="sensor-interval" min="1" max="10" step="1">
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="emergency-stop-enabled">
                                        <label class="form-check-label" for="emergency-stop-enabled">
                                            Emergency Stop Enabled
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-warning btn-lg">
                                    <i class="bi bi-save"></i> Save Pump Configuration
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="loadPumpConfig()">
                                    <i class="bi bi-arrow-clockwise"></i> Reset to Current
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-info">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Pump Status</h6>
                    </div>
                    <div class="card-body">
                        <div id="pump-status">
                            <!-- Pump status will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-success">
                        <h6 class="mb-0"><i class="bi bi-tools"></i> Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="testAllPumps()">
                            <i class="bi bi-play"></i> Test All Pumps
                        </button>
                        <button class="btn btn-outline-info btn-sm w-100" onclick="exportPumpConfig()">
                            <i class="bi bi-download"></i> Export Config
                        </button>
                    </div>
                </div>

                <div class="card mt-3 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="bi bi-speedometer2"></i> Pump Calibration</h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">
                            Calibrate pumps by running a test and measuring the actual volume dispensed.
                        </p>
                        <div class="d-grid">
                            <button class="btn btn-warning w-100" onclick="showCalibrationWizard()">
                                <i class="bi bi-gear"></i> Start Calibration Wizard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Configuration Tab -->
    <div class="tab-pane fade" id="network-config" role="tabpanel">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-info">
                        <h5 class="mb-0"><i class="bi bi-wifi"></i> Network Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="network-config-form">
                            <h6><i class="bi bi-printer"></i> Printer Connection</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Printer IP Address</label>
                                    <input type="text" class="form-control" id="printer-ip" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
                                           placeholder="192.168.4.2" required>
                                    <div class="form-text">IP address of the 3D printer</div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Port</label>
                                    <input type="number" class="form-control" id="printer-port" min="1" max="65535" value="8080">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Timeout (s)</label>
                                    <input type="number" class="form-control" id="connection-timeout" min="1" max="60" value="10">
                                </div>
                            </div>

                            <hr>

                            <h6><i class="bi bi-wifi"></i> WiFi Settings</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">WiFi SSID</label>
                                    <input type="text" class="form-control" id="wifi-ssid" placeholder="Printer_WiFi">
                                    <div class="form-text">Network name for ESP32 gateway</div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-info btn-lg">
                                    <i class="bi bi-save"></i> Save Network Configuration
                                </button>
                                <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection()">
                                    <i class="bi bi-wifi"></i> Test Connection
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-success">
                        <h6 class="mb-0"><i class="bi bi-check-circle"></i> Connection Status</h6>
                    </div>
                    <div class="card-body">
                        <div id="connection-test-result">
                            <p class="text-muted">Click "Test Connection" to check printer connectivity</p>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-warning">
                        <h6 class="mb-0"><i class="bi bi-info-triangle"></i> Network Info</h6>
                    </div>
                    <div class="card-body">
                        <small class="text-muted">
                            <strong>Network Topology:</strong><br>
                            • ESP32: 192.168.4.1 (Gateway)<br>
                            • Raspberry Pi: 192.168.4.3<br>
                            • Printer: 192.168.4.2<br><br>
                            <strong>Note:</strong> Printer IP may change if power cycled.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logging Configuration Tab -->
    <div class="tab-pane fade" id="logging-config" role="tabpanel">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-dark">
                        <h5 class="mb-0"><i class="bi bi-journal-text"></i> Logging & Debug Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="logging-config-form">
                            <h6><i class="bi bi-bug"></i> Debug Levels</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Web UI Logging</label>
                                    <select class="form-select" id="webui-log-level">
                                        <option value="ERROR">Error Only</option>
                                        <option value="WARNING">Warning</option>
                                        <option value="INFO" selected>Info</option>
                                        <option value="DEBUG">Debug</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Print Manager</label>
                                    <select class="form-select" id="print-manager-log-level">
                                        <option value="ERROR">Error Only</option>
                                        <option value="WARNING">Warning</option>
                                        <option value="INFO" selected>Info</option>
                                        <option value="DEBUG">Debug</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Pump Control</label>
                                    <select class="form-select" id="pump-log-level">
                                        <option value="ERROR">Error Only</option>
                                        <option value="WARNING">Warning</option>
                                        <option value="INFO" selected>Info</option>
                                        <option value="DEBUG">Debug</option>
                                    </select>
                                </div>
                            </div>

                            <hr>

                            <h6><i class="bi bi-file-text"></i> Log Output Options</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="console-logging" checked>
                                        <label class="form-check-label" for="console-logging">
                                            Console Output
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="file-logging">
                                        <label class="form-check-label" for="file-logging">
                                            File Logging
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="realtime-logging" checked>
                                        <label class="form-check-label" for="realtime-logging">
                                            Real-time Web Streaming
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Max Log Lines (Web UI)</label>
                                    <input type="number" class="form-control" id="max-log-lines" min="100" max="5000" value="1000">
                                    <div class="form-text">Maximum lines to keep in web interface</div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-dark btn-lg">
                                    <i class="bi bi-save"></i> Save Logging Configuration
                                </button>
                                <button type="button" class="btn btn-outline-danger ms-2" onclick="clearAllLogs()">
                                    <i class="bi bi-trash"></i> Clear All Logs
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-primary">
                        <h6 class="mb-0"><i class="bi bi-activity"></i> Live Log Preview</h6>
                    </div>
                    <div class="card-body">
                        <div id="live-log-preview" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 0.8rem;">
                            <span class="text-muted">Log messages will appear here...</span>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleLogStream()">
                                <i class="bi bi-pause"></i> Pause Stream
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hardware Diagnostics Tab -->
    <div class="tab-pane fade" id="diagnostics" role="tabpanel">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-danger">
                        <h5 class="mb-0"><i class="bi bi-cpu"></i> Hardware Diagnostics</h5>
                    </div>
                    <div class="card-body">
                        <h6><i class="bi bi-motherboard"></i> System Status</h6>
                        <div id="system-diagnostics">
                            <!-- Will be populated by JavaScript -->
                        </div>

                        <hr>

                        <h6><i class="bi bi-gear"></i> Component Tests</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="testI2C()">
                                    <i class="bi bi-motherboard"></i> Test I2C Communication
                                </button>
                                <button class="btn btn-outline-success w-100 mb-2" onclick="testGPIO()">
                                    <i class="bi bi-cpu"></i> Test GPIO Pins
                                </button>
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="testPumpMotors()">
                                    <i class="bi bi-droplet"></i> Test Pump Motors
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-info w-100 mb-2" onclick="testNetworkConnectivity()">
                                    <i class="bi bi-wifi"></i> Test Network
                                </button>
                                <button class="btn btn-outline-danger w-100 mb-2" onclick="runFullDiagnostics()">
                                    <i class="bi bi-cpu-fill"></i> Full System Test
                                </button>
                                <button class="btn btn-outline-secondary w-100 mb-2" onclick="generateDiagnosticReport()">
                                    <i class="bi bi-file-text"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-secondary">
                        <h6 class="mb-0"><i class="bi bi-speedometer2"></i> System Metrics</h6>
                    </div>
                    <div class="card-body">
                        <div id="system-metrics">
                            <div class="d-flex justify-content-between">
                                <span>CPU Usage:</span>
                                <span id="cpu-usage">--</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Memory:</span>
                                <span id="memory-usage">--</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Temperature:</span>
                                <span id="cpu-temp">--</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Uptime:</span>
                                <span id="system-uptime">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-warning">
                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Diagnostic Results</h6>
                    </div>
                    <div class="card-body">
                        <div id="diagnostic-results">
                            <p class="text-muted">Run diagnostics to see results here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pump Calibration Wizard Modal -->
<div class="modal fade" id="calibrationModal" tabindex="-1" aria-labelledby="calibrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="calibrationModalLabel">
                    <i class="bi bi-speedometer2"></i> Pump Calibration Wizard
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark">
                <!-- Step 1: Select Pump -->
                <div id="calibration-step-1" class="calibration-step">
                    <h6 class="mb-3"><i class="bi bi-1-circle-fill text-primary"></i> Select Pump to Calibrate</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pump</label>
                            <select class="form-select form-select-lg" id="cal-pump-select">
                                <option value="">-- Select Pump --</option>
                                <option value="pump_a">Pump A</option>
                                <option value="pump_b">Pump B</option>
                                <option value="pump_c">Pump C</option>
                                <option value="drain_pump">Drain Pump (D)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Test Duration (seconds)</label>
                            <input type="number" class="form-control form-control-lg" id="cal-duration" value="10" min="5" max="60">
                            <small class="text-secondary">Recommended: 10-20 seconds</small>
                        </div>
                    </div>
                    <div id="cal-pump-info" class="alert alert-info d-none">
                        <strong>Current Settings:</strong>
                        <div class="mt-2">
                            <span class="badge bg-secondary">Flow Rate: <span id="cal-current-flow">--</span> ml/s</span>
                            <span class="badge bg-secondary ms-2">Last Calibrated: <span id="cal-last-calibrated">Never</span></span>
                        </div>
                    </div>
                    <div class="d-grid mt-3">
                        <button class="btn btn-primary btn-lg" onclick="startCalibrationTest()">
                            <i class="bi bi-arrow-right"></i> Next: Run Test
                        </button>
                    </div>
                </div>

                <!-- Step 2: Run Test -->
                <div id="calibration-step-2" class="calibration-step d-none">
                    <h6 class="mb-3"><i class="bi bi-2-circle-fill text-primary"></i> Run Calibration Test</h6>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Preparation:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Place a graduated cylinder or measuring container under the pump output</li>
                            <li>Ensure the pump has sufficient material in the reservoir</li>
                            <li>Be ready to measure the dispensed volume accurately</li>
                        </ul>
                    </div>
                    <div class="text-center mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="mb-2">Test Configuration</h5>
                                <p class="mb-1"><strong>Pump:</strong> <span id="cal-test-pump-name" class="text-primary">--</span></p>
                                <p class="mb-0"><strong>Duration:</strong> <span id="cal-test-duration" class="text-primary">--</span> seconds</p>
                            </div>
                        </div>
                    </div>
                    <div id="cal-test-status" class="alert alert-secondary text-center">
                        <strong>Status:</strong> Ready to run test
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="cal-run-test-btn" onclick="runCalibrationTest()">
                            <i class="bi bi-play-fill"></i> Run Pump Test
                        </button>
                        <button class="btn btn-outline-secondary" onclick="goToCalibrationStep(1)">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                    </div>
                </div>

                <!-- Step 3: Enter Measured Volume -->
                <div id="calibration-step-3" class="calibration-step d-none">
                    <h6 class="mb-3"><i class="bi bi-3-circle-fill text-primary"></i> Enter Measured Volume</h6>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Measure the actual volume of material dispensed and enter it below.
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-8 mx-auto">
                            <label class="form-label">Dispensed Volume (ml)</label>
                            <div class="input-group input-group-lg">
                                <input type="number" class="form-control" id="cal-measured-volume" placeholder="Enter volume" min="0.1" step="0.1">
                                <span class="input-group-text">ml</span>
                            </div>
                            <small class="text-secondary">Enter the volume shown on your measuring container</small>
                        </div>
                    </div>
                    <div id="cal-calculation-result" class="d-none">
                        <div class="card bg-success text-white mb-3">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-calculator"></i> Calculated Flow Rate</h5>
                                <h2 class="display-4 mb-0"><span id="cal-calculated-flow">--</span> ml/s</h2>
                                <small class="mt-2 d-block">Based on <span id="cal-calc-volume">--</span> ml in <span id="cal-calc-duration">--</span> seconds</small>
                            </div>
                        </div>
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-body">
                                        <small class="text-muted">Previous</small>
                                        <h5 id="cal-old-flow">--</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-body">
                                        <small class="text-muted">New</small>
                                        <h5 id="cal-new-flow">--</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" onclick="calculateFlowRate()" id="cal-calculate-btn">
                            <i class="bi bi-calculator"></i> Calculate Flow Rate
                        </button>
                        <button class="btn btn-success btn-lg d-none" id="cal-save-btn" onclick="saveCalibration()">
                            <i class="bi bi-save"></i> Save Calibration
                        </button>
                        <button class="btn btn-outline-secondary" onclick="goToCalibrationStep(2)">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                    </div>
                </div>

                <!-- Step 4: Confirmation -->
                <div id="calibration-step-4" class="calibration-step d-none">
                    <div class="text-center py-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">Calibration Saved Successfully!</h4>
                        <p class="text-secondary">The new flow rate has been saved to the pump configuration.</p>
                        <div class="card bg-light mt-4 mb-4">
                            <div class="card-body">
                                <p class="mb-1"><strong>Pump:</strong> <span id="cal-final-pump">--</span></p>
                                <p class="mb-0"><strong>New Flow Rate:</strong> <span id="cal-final-flow" class="text-success">--</span> ml/s</p>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="calibrateAnotherPump()">
                                <i class="bi bi-speedometer2"></i> Calibrate Another Pump
                            </button>
                            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='config.js') }}"></script>
{% endblock %}